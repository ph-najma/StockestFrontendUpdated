<app-user-header></app-user-header>

<div class="bg-slate-50 min-h-screen">
  <!-- Header Section -->
  <div class="bg-white border-b border-slate-200 shadow-sm">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-semibold text-slate-900">Market Overview</h1>
          <!-- <p class="text-sm text-slate-600 mt-1">
            Real-time stock market data and trading
          </p> -->
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-right">
            <p class="text-sm text-slate-600">Market Status</p>
            <div class="flex items-center space-x-2">
              <div
                class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
              ></div>
              <span class="text-sm font-medium text-green-600">Live</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-6 py-8">
    <div class="flex gap-8">
      <!-- Main Content -->
      <div class="flex-1">
        <div
          class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"
        >
          <!-- Table Header -->
          <div class="bg-slate-50 px-6 py-4 border-b border-slate-200">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold text-slate-900">Stocks</h2>
              <div class="flex items-center space-x-3">
                <!-- <button
                  class="text-slate-500 hover:text-slate-700 text-sm font-medium"
                >
                  <svg
                    class="w-4 h-4 inline mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
                    ></path>
                  </svg>
                  Filter
                </button> -->
                <!-- <button
                  class="text-slate-500 hover:text-slate-700 text-sm font-medium"
                >
                  <svg
                    class="w-4 h-4 inline mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                    ></path>
                  </svg>
                  Export
                </button> -->
              </div>
            </div>
          </div>

          <!-- Stock Table -->
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-50 border-b border-slate-200">
                <tr>
                  <th
                    class="text-left py-4 px-6 text-xs font-semibold text-slate-600 uppercase tracking-wider"
                  >
                    Symbol
                  </th>
                  <th
                    class="text-left py-4 px-6 text-xs font-semibold text-slate-600 uppercase tracking-wider"
                  >
                    Company
                  </th>
                  <th
                    class="text-right py-4 px-6 text-xs font-semibold text-slate-600 uppercase tracking-wider"
                  >
                    Price
                  </th>
                  <th
                    class="text-right py-4 px-6 text-xs font-semibold text-slate-600 uppercase tracking-wider"
                  >
                    Change
                  </th>
                  <th
                    class="text-right py-4 px-6 text-xs font-semibold text-slate-600 uppercase tracking-wider"
                  >
                    Volume
                  </th>
                  <th
                    class="text-right py-4 px-6 text-xs font-semibold text-slate-600 uppercase tracking-wider"
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody
                *ngFor="let stock of stocks; let i = index"
                class="divide-y divide-slate-100"
              >
                <tr class="hover:bg-slate-50 transition-colors duration-150">
                  <!-- Symbol -->
                  <td class="py-5 px-6">
                    <div class="flex items-center">
                      <div
                        class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3"
                      >
                        <span class="text-white font-bold text-sm">{{
                          stock.symbol.substring(0, 2)
                        }}</span>
                      </div>
                      <span class="font-semibold text-slate-900 text-sm">{{
                        stock.symbol
                      }}</span>
                    </div>
                  </td>

                  <!-- Company Name -->
                  <td class="py-5 px-6">
                    <p class="text-sm font-medium text-slate-900">
                      {{ stock.symbol }}
                    </p>
                  </td>

                  <!-- Price -->
                  <td class="py-5 px-6 text-right">
                    <span class="text-lg font-semibold text-slate-900"
                      >${{ stock.price.toFixed(2) }}</span
                    >
                  </td>

                  <!-- Change -->
                  <td class="py-5 px-6 text-right">
                    <div class="flex items-center justify-end">
                      <div
                        class="flex items-center px-2.5 py-1 rounded-full text-sm font-medium"
                        [ngClass]="{
                          'bg-green-100 text-green-800': stock.change > 0,
                          'bg-red-100 text-red-800': stock.change <= 0
                        }"
                      >
                        <svg
                          *ngIf="stock.change > 0"
                          class="w-3 h-3 mr-1"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"
                          ></path>
                        </svg>
                        <svg
                          *ngIf="stock.change <= 0"
                          class="w-3 h-3 mr-1"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z"
                            clip-rule="evenodd"
                          ></path>
                        </svg>
                        {{ stock.change > 0 ? "+" : "" }}{{ stock.change }}%
                      </div>
                    </div>
                  </td>

                  <!-- Volume -->
                  <td class="py-5 px-6 text-right">
                    <span class="text-sm text-slate-600">{{
                      stock.volume | number
                    }}</span>
                  </td>

                  <!-- Actions -->
                  <td class="py-5 px-6 text-right">
                    <div class="flex items-center justify-end space-x-2">
                      <!-- Buy Button -->
                      <button
                        class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors duration-150"
                        (click)="openBuyModal(stock)"
                      >
                        <svg
                          class="w-4 h-4 mr-1"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                          ></path>
                        </svg>
                        Buy
                      </button>

                      <!-- Sell Button -->
                      <button
                        class="inline-flex items-center px-3 py-1.5 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-150"
                        (click)="openSellModal(stock)"
                      >
                        <svg
                          class="w-4 h-4 mr-1"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M20 12H4"
                          ></path>
                        </svg>
                        Sell
                      </button>

                      <!-- More Options -->
                      <div class="relative">
                        <button
                          class="inline-flex items-center p-1.5 text-slate-400 hover:text-slate-600 rounded-lg hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-300 transition-colors duration-150"
                          (click)="toggleDropdown(stock)"
                        >
                          <svg
                            class="w-5 h-5"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                          >
                            <path
                              d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"
                            ></path>
                          </svg>
                        </button>

                        <!-- Dropdown Menu -->
                        <div
                          *ngIf="isDropdownOpen(stock)"
                          class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-10"
                        >
                          <button
                            class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center"
                            (click)="addToStockList(stock)"
                          >
                            <svg
                              class="w-4 h-4 mr-2"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                              ></path>
                            </svg>
                            Add to Watchlist
                          </button>
                          <button
                            class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center"
                            (click)="tradingview(stock)"
                          >
                            <svg
                              class="w-4 h-4 mr-2"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                              ></path>
                            </svg>
                            View Chart
                          </button>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Buy Modal -->
<div
  *ngIf="isBuyModalOpen"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
>
  <div class="bg-white rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
    <!-- Modal Header -->
    <div class="px-6 py-4 border-b border-slate-200">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-xl font-semibold text-slate-900">
            Buy {{ selectedStock?.symbol }}
          </h3>
          <p class="text-sm text-slate-600 mt-1">
            {{ selectedStock?.company?.name }}
          </p>
        </div>
        <button
          class="text-slate-400 hover:text-slate-600 p-1 rounded-lg hover:bg-slate-100"
          (click)="closeBuyModal()"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Modal Body -->
    <form (submit)="buyStock()" class="p-6 space-y-6">
      <!-- Order Type Selection -->
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-3"
          >Order Type</label
        >
        <div class="grid grid-cols-3 gap-3">
          <button
            type="button"
            class="px-4 py-3 text-sm font-medium rounded-lg border transition-colors duration-150"
            [ngClass]="{
              'bg-blue-600 text-white border-blue-600': orderType === 'MARKET',
              'bg-white text-slate-700 border-slate-300 hover:bg-slate-50':
                orderType !== 'MARKET'
            }"
            (click)="orderType = 'MARKET'"
          >
            Market
          </button>
          <button
            type="button"
            class="px-4 py-3 text-sm font-medium rounded-lg border transition-colors duration-150"
            [ngClass]="{
              'bg-blue-600 text-white border-blue-600': orderType === 'LIMIT',
              'bg-white text-slate-700 border-slate-300 hover:bg-slate-50':
                orderType !== 'LIMIT'
            }"
            (click)="orderType = 'LIMIT'"
          >
            Limit
          </button>
          <button
            type="button"
            class="px-4 py-3 text-sm font-medium rounded-lg border transition-colors duration-150"
            [ngClass]="{
              'bg-blue-600 text-white border-blue-600': orderType === 'STOP',
              'bg-white text-slate-700 border-slate-300 hover:bg-slate-50':
                orderType !== 'STOP'
            }"
            (click)="orderType = 'STOP'"
          >
            Stop
          </button>
        </div>

        <!-- Intraday Toggle -->
        <div class="mt-4">
          <label class="flex items-center space-x-3 cursor-pointer">
            <input
              type="checkbox"
              (click)="changeStatus()"
              [(ngModel)]="isIntraday"
              name="isIntraday"
              class="w-4 h-4 text-blue-600 bg-slate-100 border-slate-300 rounded focus:ring-blue-500 focus:ring-2"
            />
            <span class="text-sm font-medium text-slate-700"
              >Intraday Order</span
            >
          </label>
        </div>
      </div>

      <!-- Quantity Input -->
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2"
          >Quantity</label
        >
        <input
          type="number"
          name="quantityToBuy"
          [(ngModel)]="quantityToBuy"
          class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-150"
          placeholder="Enter quantity"
          min="1"
          required
        />
      </div>

      <!-- Price Input (Conditional) -->
      <div *ngIf="orderType === 'LIMIT' || orderType === 'STOP'">
        <label class="block text-sm font-semibold text-slate-900 mb-2"
          >Price</label
        >
        <div class="relative">
          <span class="absolute left-3 top-3 text-slate-500">$</span>
          <input
            type="number"
            name="buyPrice"
            [(ngModel)]="buyPrice"
            class="w-full pl-8 pr-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-150"
            placeholder="0.00"
            min="0.01"
            step="0.01"
            required
          />
        </div>
      </div>

      <!-- Order Summary -->
      <div class="bg-slate-50 rounded-lg p-4 space-y-3">
        <h4 class="text-sm font-semibold text-slate-900">Order Summary</h4>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-slate-600">Margin Required:</span>
            <span class="font-medium text-slate-900"
              >₹{{ (buyPrice * quantityToBuy) / 5 | number : "1.2-2" }}</span
            >
          </div>
          <div class="flex justify-between">
            <span class="text-slate-600">Available Balance:</span>
            <span class="font-medium text-slate-900"
              >₹{{ userBalance | number }}</span
            >
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex space-x-3 pt-4">
        <button
          type="button"
          class="flex-1 px-4 py-3 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-300 transition-colors duration-150"
          (click)="closeBuyModal()"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="flex-1 px-4 py-3 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors duration-150"
        >
          Place Buy Order
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Enhanced Sell Modal -->
<div
  *ngIf="isSellModalOpen"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
>
  <div class="bg-white rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
    <!-- Modal Header -->
    <div class="px-6 py-4 border-b border-slate-200">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-xl font-semibold text-slate-900">
            Sell {{ selectedStock?.symbol }}
          </h3>
          <p class="text-sm text-slate-600 mt-1">
            {{ selectedStock?.company?.name }}
          </p>
        </div>
        <button
          class="text-slate-400 hover:text-slate-600 p-1 rounded-lg hover:bg-slate-100"
          (click)="closeSellModal()"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Modal Body -->
    <form (submit)="sellStock()" class="p-6 space-y-6">
      <!-- Order Type Selection -->
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-3"
          >Order Type</label
        >
        <div class="grid grid-cols-3 gap-3">
          <button
            type="button"
            class="px-4 py-3 text-sm font-medium rounded-lg border transition-colors duration-150"
            [ngClass]="{
              'bg-blue-600 text-white border-blue-600': orderType === 'MARKET',
              'bg-white text-slate-700 border-slate-300 hover:bg-slate-50':
                orderType !== 'MARKET'
            }"
            (click)="orderType = 'MARKET'"
          >
            Market
          </button>
          <button
            type="button"
            class="px-4 py-3 text-sm font-medium rounded-lg border transition-colors duration-150"
            [ngClass]="{
              'bg-blue-600 text-white border-blue-600': orderType === 'LIMIT',
              'bg-white text-slate-700 border-slate-300 hover:bg-slate-50':
                orderType !== 'LIMIT'
            }"
            (click)="orderType = 'LIMIT'"
          >
            Limit
          </button>
          <button
            type="button"
            class="px-4 py-3 text-sm font-medium rounded-lg border transition-colors duration-150"
            [ngClass]="{
              'bg-blue-600 text-white border-blue-600': orderType === 'STOP',
              'bg-white text-slate-700 border-slate-300 hover:bg-slate-50':
                orderType !== 'STOP'
            }"
            (click)="orderType = 'STOP'"
          >
            Stop
          </button>
        </div>
      </div>

      <!-- Quantity Input -->
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-2"
          >Quantity</label
        >
        <input
          type="number"
          name="quantityToSell"
          [(ngModel)]="quantityToSell"
          class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-150"
          placeholder="Enter quantity"
          min="1"
          [max]="selectedStock?.quantity"
          required
        />
      </div>

      <!-- Price Input (Conditional) -->
      <div *ngIf="orderType === 'LIMIT' || orderType === 'STOP'">
        <label class="block text-sm font-semibold text-slate-900 mb-2"
          >Price</label
        >
        <div class="relative">
          <span class="absolute left-3 top-3 text-slate-500">$</span>
          <input
            type="number"
            name="sellPrice"
            [(ngModel)]="sellPrice"
            class="w-full pl-8 pr-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-150"
            placeholder="0.00"
            min="0.01"
            step="0.01"
            required
          />
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex space-x-3 pt-4">
        <button
          type="button"
          class="flex-1 px-4 py-3 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-300 transition-colors duration-150"
          (click)="closeSellModal()"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="flex-1 px-4 py-3 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-150"
        >
          Place Sell Order
        </button>
      </div>
    </form>
  </div>
</div>
